{
  "hash": "9aa77a54f64472f326a333e957501d87",
  "result": {
    "markdown": "---\ntitle:  \"The Last Decade: NHL’s Best and Worst Power Play Teams\"\nauthor: \"Matthew J. Kmiecik\"\ndate:   \"15 May 2017\"\ndescription: \"My initial (although incorrect) attempt at modeling NHL power play data.\"\ncategories:\n  - Academic\n  - Hockey Analytics\n  - R\nformat:\n  html:\n    toc: true\n    toc-depth: 2\n    toc-location: left\n    smooth-scroll: true\n---\n\n\n\n\n<br >\n\n:::{.callout-important}\nNote: This blog post presents a model of powerplay goals in the NHL over 10 years. However, this model is inaccurate. I encourage readers to read this post and then proceed to my [follow-up blog post](https://mattkmiecik.com/post-Multilevel-Modeling-in-R-with-NHL-Power-Play-Data.html) where I explain the source of these potential errors and provide a more accurate and informative model.\n:::\n\nSo you are watching your favorite NHL team and they finally draw a powerplay. Awesome! The ice opens up with the missing player and it shouldn't be too hard to score...right? As a previous water polo player, I know what it is like to endure the wrath of a furious coach after a missed man advantage opportunity. In my experience, coaches semed convinced that the man-up should lead to a goal 100% of the time. But how important is this seemingly advantageous situation in the NHL?  \n\nAs a first pass, I analyzed the NHL regular-season over the past ten years (2007-2017) on the standard 5 vs. 4 power play.  These data were retrieved via [Corsica](http://www.corsica.hockey/teams/) shortly after the end of the 2017 regular season.  The following will detail the analyses in R with steps along the way utilizing the wonderful R packages of ggplot2 (Wickham, 2009) and dplyr (Wickham & Francois, 2016).  \n\nFirst, I loaded the data and made sure to combine the entries of the Atlanta Thrashers and the Winnipeg Jets, as the Thrashers moved to Winnipeg after the 2011 season. Therefore, the Thrashers and the Jets are considered the same team in this analysis.  \n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n# Load packages\nlibrary(tidyverse); library(plotly); library(httr)\n\n# Step 1: Load data\nlink <- \"https://raw.githubusercontent.com/mkmiecik14/mkmiecik14.github.io/master/data/corsicaData_5v4.csv\"\n\n# from https://stackoverflow.com/questions/60714074/download-csv-file-from-github-using-httr-get-request\ndata <- GET(link)\ndata5v4 <- read_csv(content(data, \"raw\"))\n\n# Step 2: Clean up the data a little bit\n# ATL moved to WPG for 2011-2012 season\ndata5v4$Team <- plyr::revalue(data5v4$Team, c(ATL = 'ATL.WPG', WPG = 'ATL.WPG'))\n```\n:::\n\n\nNext, I plotted the global trend of total regular-season power play goals for each of the 30 NHL teams over the last decade.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n# Step 2a: Look at power play goals 5v4 for every team in the past \nggplot(data5v4, aes(factor(Season), GF, group = 1)) +\n  geom_line(aes(group = factor(Team)), alpha = 1/2) + \n  geom_line(stat = 'summary', fun.y = 'mean', colour = 'red') +\n  xlab('Season') +\n  ylab('Total Season Power Play Goals (5v4)') +\n  theme(axis.text.x = element_text(angle = 15, hjust = 1))\n```\n\n::: {.cell-output-display}\n![](post-The-Last-Decade-NHLs-Best-and-Worst-Power-Play-Teams_files/figure-html/decade-nhl-power-play-1.png){fig-align='center' width=672}\n:::\n:::\n\n\nIn this above plot, each team is a grey line, while the average total power play goals for each season is plotted in the red trend line.  However, we see that this doesn’t control for the shortened lockout season that occurred in 2012-2013.  Let’s control for this by dividing the total power play goals (GF) by the total games played (GP) each season.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n# Step 2b: Control for games played due to partial lockout season (2012-2013)\nggplot(data5v4, aes(factor(Season), GF/GP, group = 1)) +\n  geom_line(aes(group = factor(Team)), alpha = 1/2) + \n  geom_line(stat = 'summary', fun.y = 'mean', colour = 'red') +\n  xlab('Season') +\n  ylab('Total Season Power Play Goals/Games Played (5v4)') +\n  theme(axis.text.x = element_text(angle = 15, hjust = 1))\n```\n\n::: {.cell-output-display}\n![](post-The-Last-Decade-NHLs-Best-and-Worst-Power-Play-Teams_files/figure-html/decade-nhl-power-play-controlled-1.png){fig-align='center' width=672}\n:::\n:::\n\n\nWe now see each team’s power play performance controlled for the games played that season.  What is interesting about this above plot is the seemingly decrease in power play goals across time.  Let’s model this with a linear regression that predicts the total season power play goals controlled for games played as a function of time/season.\n  \n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n# Step 3a: Linearly model this negative relationship between \n# power play goals/game and season\nmod <- lm((GF/GP) ~ factor(Season), data = data5v4)\nsummary(mod) # Very significant negative trend over time\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n> \n> Call:\n> lm(formula = (GF/GP) ~ factor(Season), data = data5v4)\n> \n> Residuals:\n>      Min       1Q   Median       3Q      Max \n> -0.24268 -0.06463 -0.00878  0.05407  0.33333 \n> \n> Coefficients:\n>                        Estimate Std. Error t value Pr(>|t|)    \n> (Intercept)             0.64176    0.01890  33.953  < 2e-16 ***\n> factor(Season)20082009  0.03628    0.02673   1.357 0.175726    \n> factor(Season)20092010 -0.04644    0.02673  -1.737 0.083394 .  \n> factor(Season)20102011 -0.09420    0.02673  -3.524 0.000494 ***\n> factor(Season)20112012 -0.13776    0.02673  -5.154 4.73e-07 ***\n> factor(Season)20122013 -0.12093    0.02673  -4.524 8.86e-06 ***\n> factor(Season)20132014 -0.11779    0.02673  -4.407 1.48e-05 ***\n> factor(Season)20142015 -0.12875    0.02673  -4.817 2.36e-06 ***\n> factor(Season)20152016 -0.12591    0.02673  -4.710 3.84e-06 ***\n> factor(Season)20162017 -0.12555    0.02673  -4.697 4.08e-06 ***\n> ---\n> Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n> \n> Residual standard error: 0.1035 on 290 degrees of freedom\n> Multiple R-squared:  0.2464,\tAdjusted R-squared:  0.223 \n> F-statistic: 10.54 on 9 and 290 DF,  p-value: 4.082e-14\n```\n:::\n:::\n\n\nAs we can see from the regression model and coefficients, power play goals are decreasing with each successive season. Here is a plot of this negative trend in blue.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n# Step 3b: Plot this linear trend over time\nggplot(data5v4, aes(factor(Season), GF/GP, group = 1)) +\n  geom_line(aes(group = factor(Team)), alpha = 1/2) + \n  geom_line(stat = 'summary', fun.y = 'mean', colour = 'red') +\n  xlab('Season') +\n  ylab('Total Season Power Play Goals/Games Played (5v4)') +\n  stat_smooth(method = 'lm', col = 'blue', se = F) +\n  theme(axis.text.x = element_text(angle = 15, hjust = 1))\n```\n\n::: {.cell-output-display}\n![](post-The-Last-Decade-NHLs-Best-and-Worst-Power-Play-Teams_files/figure-html/decade-nhl-power-play-decrease-1.png){fig-align='center' width=672}\n:::\n:::\n\n\nI then wondered which teams, despite this decrease in power play goals over time, had the best or worst power play across the last decade?  To remove this negative trend over time, I extracted the residuals from the model. The residuals are simply the distance from the blue line (the predicted power play goals over time) to each team’s grey line (total power play goals/games played for each year).\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n# Step 4a: Remove this linear trend and focus on residuals\n# This will examine teams' performance after controlling for this decrease in\n# powerplay goals in the last decade\ndata5v4$rel_ppg <- resid(mod)\n```\n:::\n\n\nNext, I averaged these residuals for each individual team over ten years and ran one-sample t-tests to see the teams that significantly deviated from the average.  \n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n# Step 4b: Average the residuals for each team over the past decade. Then,\n# perform a one-sample t-test (i.e., from zero) to see teams that were above\n# or below the average power play goals/game despite the decrease in \n# power play goals in the last decade  \nbestPP <- data5v4 %>% \n  group_by(Team) %>% \n  summarise_at('rel_ppg', \n               funs(mean = mean,\n                    sd = sd,\n                    sem = sd(.)/sqrt(n()),\n                    tpval = t.test(.)$p.value)) %>%\n  mutate(sig = tpval < .05)\nprint(bestPP)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n> # A tibble: 30 × 6\n>    Team         mean     sd    sem   tpval sig  \n>    <chr>       <dbl>  <dbl>  <dbl>   <dbl> <lgl>\n>  1 ANA      0.0296   0.0814 0.0257 0.280   FALSE\n>  2 ARI     -0.0556   0.0777 0.0246 0.0497  TRUE \n>  3 ATL.WPG -0.0456   0.0735 0.0232 0.0811  FALSE\n>  4 BOS     -0.0250   0.102  0.0323 0.459   FALSE\n>  5 BUF     -0.0230   0.0987 0.0312 0.479   FALSE\n>  6 CAR     -0.0102   0.0896 0.0283 0.726   FALSE\n>  7 CBJ     -0.0532   0.0891 0.0282 0.0919  FALSE\n>  8 CGY     -0.0112   0.0604 0.0191 0.573   FALSE\n>  9 CHI     -0.000760 0.0836 0.0264 0.978   FALSE\n> 10 COL     -0.0783   0.0669 0.0212 0.00493 TRUE \n> # … with 20 more rows\n```\n:::\n:::\n\n\nFinally, I plotted these results. Teams that have positive averages that are different from zero are teams that are above average in the power play, despite the decrease in power play goals scored in the last decade.  The teams with negative residual averages are the opposite and are below average in the power play. Error bars represent the standard error of the mean.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n# Step 4c: Plot the average residuals, their standard error of the mean,\n# and color based on if significantly different from 0 (i.e., average PPG/Game)\n\n# -- To get y.axis bold conditional -- # \nbestPPSort <- arrange(bestPP, mean)                       \naxisFace <- ifelse(bestPPSort$sig == T,'bold', 'plain')\n# -- To get y.axis bold conditional -- #\n  \n# -- To get shading conditional -- #\nabove <- bestPP %>% filter(mean > 0, sig == TRUE) %>% arrange(mean)\naverage <- bestPP %>% filter(sig == FALSE)\nbelow <- bestPP %>% filter(mean < 0, sig == TRUE) %>% arrange(mean)\n# -- To get shading conditional -- #\n  \nggplot(bestPP, aes(mean, reorder(Team, mean), colour = sig)) +\n  geom_errorbarh(aes(xmin = mean - sem, xmax = mean + sem)) +\n  geom_point(size = 2) +\n  scale_x_continuous(limits = (c(-.2, .2))) +\n  scale_color_manual(\n    values = c('grey', 'black'),\n    guide = guide_legend(\n      reverse = T, title = 'Above/Below Average', title.position = 'top')\n    ) +\n  labs(\n    x = 'Mean Power Play Goals/Games Played (Residuals)',\n    y = 'NHL Team',\n    title = 'NHL 5v4 Power Play Team Performance 2007-2017',\n    caption = 'Error bars are SEM'\n    ) +\n  theme_minimal() +\n  theme(\n    axis.text.y = element_text(face = axisFace),\n    plot.title = element_text(hjust = 0.5),\n    legend.position = 'bottom',\n    legend.key = element_rect(colour = \"transparent\", fill = \"white\"),\n    legend.key.width = unit(1, 'in'),\n    legend.key.height = unit(.5, 'in'),\n    legend.title.align = .5,\n    axis.title.x = element_text(vjust = -1)\n    ) +\n  annotate(\n    'rect', \n     xmin = -Inf, \n     xmax = Inf, \n     ymax = above$Team[nrow(above)],\n     ymin = above$Team[1], \n     fill = '#33a02c', \n     alpha = 1/3\n    ) +\n  annotate(\n    'rect', \n     xmin = -Inf, \n     xmax = Inf, \n     ymax = below$Team[nrow(below)],\n     ymin = below$Team[1], \n     fill = '#e31a1c', \n     alpha = 1/3\n    ) +\n  annotate('text', x = -.1, y = above$Team[3], label = 'Best Teams') +\n  annotate('text', x = .1, y = below$Team[4], label = 'Worst Teams')\n```\n\n::: {.cell-output-display}\n![](post-The-Last-Decade-NHLs-Best-and-Worst-Power-Play-Teams_files/figure-html/nhl-best-worst-power-play-teams-1.png){fig-align='center' width=672}\n:::\n:::\n\n\nAs we can see from this plot, the top power play teams in the past decade have been the Washington Capitals, Philadelphia Flyers, Detroit Red Wings, San Jose Sharks, and Pittsburgh Penguins. Meanwhile, the worst power play teams have been the New York Islanders, Phoenix Coyotes, Nashville Predators, New York Rangers, New Jersey Devils, Colorado Avalanche, and Florida Panthers.  \n\nInterestingly, only 5 different teams have won the Stanley Cup in this ten year span.  Of the top power play teams from this analysis, only the Red Wings and the Penguins have won the Stanley Cup, while the Blackhawks, the Kings, the Bruins all had average regular-season power plays. It is unclear how regular-season power play performance relates to Stanley Cup wins; however, this analysis demonstrated 3 key findings for this last decade of hockey (2007 – 2017):\n\n1. League-wide total power play goals per season have decreased \n2. Top power play teams are:\n+ Washington Capitals\n+ Philadelphia Flyers\n+ Detroit Red Wings\n+ San Jose Sharks\n+ Pittsburgh Penguins\n3. Worst power play teams are:\n+ New York Islanders\n+ Phoenix Coyotes\n+ Nashville Predators\n+ New York Rangers\n+ New Jersey Devils\n+ Colorado Avalanche\n+ Florida Panthers  \n\n# Acknowledgments\n\nThis analysis was inspired by Part III of [ggplot2: Elegant Graphics for Data Analysis](https://github.com/hadley/ggplot2-book) by Hadley Wickham.\n\n\n# References:\n\nWickham, H. 2009. ggplot2: Elegant Graphics for Data Analysis. Book. Springer-Verlag New York. http://ggplot2.org.\n\nWickham, H., and R. Francois. 2016. dplyr: A Grammar of Data Manipulation. https://CRAN.R-project.org/package=dplyr.\n\n<!-- disqus START -->\n\n<div id=\"disqus_thread\"></div>\n<script>\n/**\n*  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.\n*  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/\n/*\nvar disqus_config = function () {\nthis.page.url = 'https://mattkmiecik.com/post-The-Last-Decade-NHLs-Best-and-Worst-Power-Play-Teams.html';  // Replace PAGE_URL with your page's canonical URL variable\nthis.page.identifier = 'post-The-Last-Decade-NHLs-Best-and-Worst-Power-Play-Teams'; // Replace PAGE_IDENTIFIER with your page's unique identifier variable\n};\n*/\n(function() { // DON'T EDIT BELOW THIS LINE\nvar d = document, s = d.createElement('script');\ns.src = 'https://mattkmiecik.disqus.com/embed.js';\ns.setAttribute('data-timestamp', +new Date());\n(d.head || d.body).appendChild(s);\n})();\n</script>\n<noscript>Please enable JavaScript to view the <a href=\"https://disqus.com/?ref_noscript\">comments powered by Disqus.</a></noscript>\n\n<!-- disqus END -->",
    "supporting": [
      "post-The-Last-Decade-NHLs-Best-and-Worst-Power-Play-Teams_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}