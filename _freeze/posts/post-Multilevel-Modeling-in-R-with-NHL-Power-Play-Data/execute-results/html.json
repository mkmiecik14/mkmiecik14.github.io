{
  "hash": "1f33d143aa8b0f17af28e084bc521324",
  "result": {
    "markdown": "---\ntitle: \"Multilevel Modeling in R with NHL Power Play Data\"\nauthor: \"Ekarin Pongpipat & Matthew J. Kmiecik\"\ndate: \"11 February 2018\"\ndescription: \"A walkthrough of sequential multilevel modeling in R using NHL data.\"\ncategories:\n  - Academic\n  - Hockey Analytics\n  - R\nformat:\n  html:\n    toc: true\n    toc-depth: 2\n    toc-location: left\n    smooth-scroll: true\n---\n\n\n\n\n<br >\n\n# Introduction\n\nIn a [previous post](https://mattkmiecik.com/post-The-Last-Decade-NHLs-Best-and-Worst-Power-Play-Teams.html), I was interested in determining if there were any fluctuations in the frequency of powerplay goals (5 on 4) in the NHL across one decade (2007-2017). The statistial technique of choice was linear regression.\n\nHowever, there were a few issues with this statistical modeling procedure:\n\n1. This model did not account for the variability within each team. In other words, the model did not appreciate each team's change in powerplay goals across time individually. When we do not account for this variability (within-team variance), the unsystematic error is seemingly reduced, and subsequently an increase in our test statistic, decrease in p-value, and ultimately an increase in Type I error rate\n2. Time was treated as a factor (i.e., categorical variable). However, time is actually a continuous construct and may reveal more informaton when treated as such\n\n:::{.callout-important}\nI had a feeling something was off here. So, I turned to one of my fellow classmates, Ekarin Pongpipat, to teach me a technique that could remedy this situation. The following is what we produced after two Saturday afternoons! Thanks again Ekarin!\n:::\n\nTo improve this model of NHL 5v4 powerplay goals, we utilized a multi-level linear regression model. The purpose of this post is three-fold:\n\n1. Create a more accurate model of NHL powerplay goal fluctuations across the 2007-2017 decade\n2. Explore these data with plenty of plots\n3. Provide a tutorial of multi-level linear modeling in R\n\n# Setup\n\nLet's first load some useful packages for analysis and plotting:\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nlibrary(tidyverse); library(httr); library(broom); \nlibrary(gridExtra); library(knitr); library(kableExtra);\nlibrary(RColorBrewer)\n```\n:::\n\n\nThese data were retrieved via [Corsica](http://corsica.hockey/) shortly after the end of the 2017 regular season and are also available on this [website's Github repository](https://github.com/mkmiecik14/mkmiecik14.github.io). Feel free to pull these data from the repository like this:\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nlink <- 'https://raw.githubusercontent.com/mkmiecik14/mkmiecik14.github.io/master/data/corsicaData_5v4.csv'\n\n# from https://stackoverflow.com/questions/60714074/download-csv-file-from-github-using-httr-get-request\ndata <- GET(link)\ndata5v4 <- read_csv(content(data, \"raw\"))\n```\n:::\n\n\nThe Atlanta Thrashers moved to Winnipeg (Jets) after the 2011 season. Therefore, we combined the entries of the Atlanta Thrashers and the Winnipeg Jets. **The Thrashers and the Jets are considered the same team in this analysis.**\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n# Combining ATL and WPG as ATL.WPG\ndata5v4$Team <- plyr::revalue(data5v4$Team, c(ATL = 'ATL.WPG', WPG = 'ATL.WPG'))\n```\n:::\n\n\nFor the regression models, it is more desirable to have the year be represented as a continuous variable. This way an increase of 1 year is the equivalent of 1 year of hockey played. This will translate to more interpretable regression coefficents. Year was recoded as the starting year of the season (e.g., 20162017 = 2016):\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ndata5v4 <- \n  data5v4 %>% \n  separate(Season, c('StartYear', 'EndYear'), sep = 4, remove = F) %>%\n  mutate_at(c('StartYear', 'EndYear'), funs(as.numeric))\n```\n:::\n\n\nNext, we coded each team into its division following the 2013-2014 realignment scheme. \n\n**Note: This has serious implications for our later analysis of conference and divisions. This realignment took place 6 years from the first season in this analysis. Therefore, identifying the teams using this realignment scheme is used for illustrative purposes.**\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n# Initializing variables to store team names\npacific <- c('S.J', 'CGY', 'L.A', 'ANA', 'EDM', 'VAN', 'ARI')\ncentral <- c('ATL.WPG', 'NSH', 'STL', 'DAL', 'COL', 'MIN', 'CHI')\nmetropolitan <- c('WSH', 'N.J', 'PHI', 'CBJ', 'PIT', 'NYR', 'NYI', 'CAR')\natlantic <- c('T.B', 'BOS', 'TOR', 'DET', 'MTL', 'FLA', 'OTT', 'BUF')\n\n# Creating a column to identify each team's division\ndata5v4 <- data5v4 %>%\n  mutate(\n    division = case_when(\n      data5v4$Team %in% pacific ~ 'Pacific',\n      data5v4$Team %in% central ~ 'Central',\n      data5v4$Team %in% metropolitan ~ 'Metropolitan',\n      data5v4$Team %in% atlantic ~ 'Atlantic')\n    )\n```\n:::\n\n\nHere is a table detailing the 2013 realignment:\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n# Creates the data frame for html table\ndivisions <- \n  data.frame(\n    Pacific = c(pacific, ''),\n    Central = c(central, ''),\n    Metropolitan = metropolitan,\n    Atlantic = atlantic\n    )\n\n# Prints table\nkable(divisions) %>%\n  kable_styling(bootstrap_options = c('striped', 'hover', 'responsive'))\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table table-striped table-hover table-responsive\" style=\"margin-left: auto; margin-right: auto;\">\n <thead>\n  <tr>\n   <th style=\"text-align:left;\"> Pacific </th>\n   <th style=\"text-align:left;\"> Central </th>\n   <th style=\"text-align:left;\"> Metropolitan </th>\n   <th style=\"text-align:left;\"> Atlantic </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> S.J </td>\n   <td style=\"text-align:left;\"> ATL.WPG </td>\n   <td style=\"text-align:left;\"> WSH </td>\n   <td style=\"text-align:left;\"> T.B </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> CGY </td>\n   <td style=\"text-align:left;\"> NSH </td>\n   <td style=\"text-align:left;\"> N.J </td>\n   <td style=\"text-align:left;\"> BOS </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> L.A </td>\n   <td style=\"text-align:left;\"> STL </td>\n   <td style=\"text-align:left;\"> PHI </td>\n   <td style=\"text-align:left;\"> TOR </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> ANA </td>\n   <td style=\"text-align:left;\"> DAL </td>\n   <td style=\"text-align:left;\"> CBJ </td>\n   <td style=\"text-align:left;\"> DET </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> EDM </td>\n   <td style=\"text-align:left;\"> COL </td>\n   <td style=\"text-align:left;\"> PIT </td>\n   <td style=\"text-align:left;\"> MTL </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> VAN </td>\n   <td style=\"text-align:left;\"> MIN </td>\n   <td style=\"text-align:left;\"> NYR </td>\n   <td style=\"text-align:left;\"> FLA </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> ARI </td>\n   <td style=\"text-align:left;\"> CHI </td>\n   <td style=\"text-align:left;\"> NYI </td>\n   <td style=\"text-align:left;\"> OTT </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\">  </td>\n   <td style=\"text-align:left;\">  </td>\n   <td style=\"text-align:left;\"> CAR </td>\n   <td style=\"text-align:left;\"> BUF </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\n# Data Exploration\n\nBefore analysis, let's first explore these data via various plots. One question we are interested in is, \"Are the amount of standard 5 vs. 4 regular season power play goals changing over time across 10 years (2007-2017) in the NHL?\"\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nggplot(data5v4, aes(StartYear, GF, group = 1)) +\n  geom_line(aes(group = Team, color = division), alpha = 2/3) + \n  geom_line(stat = 'summary', fun.y = 'mean', size = .9, color = 'red') +\n  scale_color_brewer(palette = 'Blues', direction = -1) +\n  labs(x = 'Season (Start Year)',\n       y = 'Total Season Power Play Goals (5v4)',\n       caption = 'Each team is a separate line; red line is the average') +\n  guides(color = guide_legend(title = 'Division')) +\n  scale_x_continuous(limits = c(2007, 2016), breaks = c(2007:2016)) +\n  theme_minimal()\n```\n\n::: {.cell-output-display}\n![](post-Multilevel-Modeling-in-R-with-NHL-Power-Play-Data_files/figure-html/vis1-1.png){fig-align='center' width=672}\n:::\n:::\n\n\nThe plot above demonstrates a dramatic decrease in power play goals, league-wide, during the 2012-2013 season. This is clearly a result of the shortened season, which would greatly reduce the amount of powerplay goal attempts, due to the 2012-2013 NHL lockout.\n\nLet's control for this shortended season by dividing the powerplay goals (GF) by the amount of games played (GP) per season:\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nggplot(data5v4, aes(StartYear, GF/GP, group = 1)) +\n  geom_line(aes(group = Team, color = division), alpha = 2/3) + \n  geom_line(stat = 'summary', fun.y = 'mean', size = .9, color = 'red') +\n  scale_color_brewer(palette = 'Blues', direction = -1) +\n  labs(x = 'Season (Start Year)',\n       y = 'Total Season Power Play Goals/Games Played (5v4)',\n       caption = 'Each team is a separate line; red line is the average') +\n  guides(color = guide_legend(title = 'Division')) +\n  scale_x_continuous(limits = c(2007, 2016), breaks = c(2007:2016)) +\n  theme_minimal()\n```\n\n::: {.cell-output-display}\n![](post-Multilevel-Modeling-in-R-with-NHL-Power-Play-Data_files/figure-html/vis2-1.png){fig-align='center' width=672}\n:::\n:::\n\n\nNow that we've controlled for the number of games played per season, we can see that there seems to be a decrease in the average powerplay goals (red line) scored per season for each subsequent year of play.\n\nFurther ways to plot these data include a boxplot and an average trend line:\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nyaxlim <- c(.25,1) # Locks y-axis\n\n# Box plot\nboxplot <- \n  ggplot(data5v4, aes(factor(StartYear), GF/GP, group = StartYear)) +\n  geom_boxplot() +\n  labs(\n    x = 'Season (Start Year)',\n    y = 'Total Season Power Play Goals/Games Played (5v4)',\n    caption = ' '\n    ) +\n  coord_cartesian(ylim = yaxlim) +\n  theme_minimal()\n\n# Summary for line plot\ndata5v4_sum <- \n  data5v4 %>% \n  group_by(StartYear) %>% \n  summarise(\n    mean = mean(GF/GP),\n    sd = mean(GF/GP),\n    n = n(),\n    sem = sd/sqrt(n)\n    )\n\n# Line plot\nlineplot <- \n  ggplot(data5v4_sum, aes(factor(StartYear), mean, group = 1)) +\n  geom_line(alpha = 1/3) +\n  geom_pointrange(aes(ymax = mean + sem, ymin = mean - sem)) +\n  coord_cartesian(ylim = yaxlim) +\n  labs(x = 'Season (Start Year)', caption = 'Error bars are SEM') +\n  theme_minimal() +\n  theme(axis.title.y = element_blank())\n  \n# Arranges plots side-by-side\ngrid.arrange(boxplot, lineplot, ncol = 2)\n```\n\n::: {.cell-output-display}\n![](post-Multilevel-Modeling-in-R-with-NHL-Power-Play-Data_files/figure-html/vis3-1.png){fig-align='center' width=672}\n:::\n:::\n\n\n# Multi-level Linear Modeling\n\nBefore we begin modeling these data, let's visualize how these data are structured hierarchically (or in multiple levels).\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](../images/figure1.svg){fig-align='center' width=100%}\n:::\n:::\n\n\nAccording to this hierarchy, the NHL has two conferences that each have two divisions, each of which have 7 or 8 distinct teams.\n\nWe'll first model each team's powerplay performance across 10 years separately in level 1. Then, we'll model these performances between and within each conference and division in level 2.\n\n## Level 1 \n\nThe level 1 modeling ignores the conference and division distinction. Each team will be modeled individually using a linear regression to predict powerplay goals per games played as a function of time (across 10 years). There are 30 teams in this dataset. Therefore, 30 distinct linear regressions will be performed; one for each team in the NHL. This allows us account for the variability of power plays within each team.\n\nThe code for this is made extremely efficient thanks to dplyr pipe-ing (%>%):\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nmodTeam <-  \n  data5v4 %>% \n  nest_by(Team) %>%\n  mutate(level1 = list(lm((GF/GP) ~ StartYear, data = data)))\n```\n:::\n\n\nExtracting omnibus level statistics, such as _R^2^_, for each of the 30 linear regressions and placing them in a easy-to-use dataframe was done using the 'broom' package function 'glance':\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nlevel1Omni <- \n  modTeam %>% \n  summarise(broom::glance(level1)) %>% \n  ungroup() %>% \n  mutate(sig = p.value < .05)\n```\n:::\n\n\nWe'll use these omnibus estimates to examine all 30 regression models simultaneously via _R^2^_ estimates. These allow us to see how much variability in powerplay goals per games played was explained by time:\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n# Color palette\nsigColorPal <- brewer.pal(11,'RdGy') # display.brewer.pal(11,'RdGy')\n\n# R^2 Plot\nggplot(level1Omni, aes(r.squared, reorder(Team, r.squared), color = sig)) +\n  geom_point(size = 2) +\n  scale_color_manual(values = sigColorPal[c(9,2)]) +\n  labs(x = 'R-squared', y = 'Team') +\n  guides(color = guide_legend(title = 'p < .05')) +\n  theme_minimal()\n```\n\n::: {.cell-output-display}\n![](post-Multilevel-Modeling-in-R-with-NHL-Power-Play-Data_files/figure-html/level1_fig1-1.png){fig-align='center' width=672}\n:::\n:::\n\n\nWe can also similarly examine the regression coefficient of time for each NHL team. This coefficient tells us what was the predicted change in powerplay goals per games played across the ten years (2007-2017).\n\nLet's first extract these coefficients using dplyr pipeing (%>%) and the 'broom' package function 'tidy': \n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n# Extracting level 1 coefficients\nlevel1Coef <- \n  modTeam %>% \n  summarise(broom::tidy(level1)) %>% \n  ungroup() %>%\n  filter(term == 'StartYear') %>%   # Facilitates plotting\n  mutate(sig = p.value < .05)       # For later plotting\n```\n:::\n\n\nNow let's plot these coefficients ordered by size:\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nggplot(level1Coef, aes(estimate, reorder(Team, -1*estimate), color = sig)) +\n  geom_point(size = 2) +\n  geom_errorbarh(\n    aes(xmin = estimate - std.error, xmax = estimate + std.error),\n    alpha = 1/2\n    ) +\n  scale_color_manual(values = sigColorPal[c(9,2)]) +\n  labs(\n    x = 'Estimate (Yearly Change in Power Play Goals/Game)', \n    y = 'Team',\n    caption = 'SEM error bars'\n    ) +\n  guides(color = guide_legend(title = 'p < .05')) +\n  theme_minimal()\n```\n\n::: {.cell-output-display}\n![](post-Multilevel-Modeling-in-R-with-NHL-Power-Play-Data_files/figure-html/level1_3fig-1.png){fig-align='center' width=672}\n:::\n:::\n\n\nAs we can see from the plot above, each team had a different predicted rate of change in powerplay goals per games played from 2007-2017. The x-axis here represents the regression coefficient of time. For example, the Chicago Blackhawks had an estimate close to -.02. This means that for every increase in 1 year (every season) the model predicted a decrease of .02 powerplay goals per games played. However, this estimate is colored grey. This means that it was not found to be significantly different from zero.\n\nFor a more comprehensive picture, let's look at all the teams in the NHL plotted with both the observed (actual) data and model predicted trendlines. To do this, let's first extract the model fits by using dplyr pipeing (%>%) and the 'broom' package function 'augment':\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n# Extracting level 1 model fits\nlevel1Fits <- \n  modTeam %>% \n  summarise(broom::augment(level1)) %>%\n  ungroup() %>%\n  mutate(sig = rep(level1Coef$sig, each = length(unique(StartYear))))\n```\n:::\n\n\nAnd then plot them using ggplot:\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nggplot(level1Fits, aes(StartYear, color = sig)) +\n  geom_line(aes(y = .fitted), alpha = 2/3) +\n  scale_color_manual(values = sigColorPal[c(9,2)]) +\n  geom_line(aes(y = `(GF/GP)`), color = 'black') +\n  labs(\n    x = 'Season (Start Year)',\n    y = 'Power Play Goals/Games Played (5v4)'\n    ) +\n  scale_x_continuous(breaks = c(2008, 2015)) +\n  facet_wrap(~Team, ncol = 5) +\n  guides(color = guide_legend(title = 'p < .05')) +\n  theme_minimal() +\n  theme(legend.position = 'bottom')\n```\n\n::: {.cell-output-display}\n![](post-Multilevel-Modeling-in-R-with-NHL-Power-Play-Data_files/figure-html/level1_4fig-1.png){fig-align='center' width=672}\n:::\n:::\n\n\n## Level 2\n\nHere's what we've learned from level 1:\n\n1. The rate of change in powerplay goals per games played seems different from team to team\n2. There seems to be a general decrease in powerplay goals per games played across time\n\nWe can take this a step further by asking the question: \"Are powerplay goals per games played changing as a function of time across all NHL teams **on average**.\"\n\nOne way to test this question is to see if the regression coefficients of time from level 1 across all 30 NHL teams, on average, differ from zero.\n\nOur coefficients are already in a dataframe named 'level1Coef', so let's use this dataframe to test whether these estimates are different from zero:\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nlevel2 <- lm(estimate ~ 1, data = level1Coef)\nsummary(level2)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\nCall:\nlm(formula = estimate ~ 1, data = level1Coef)\n\nResiduals:\n      Min        1Q    Median        3Q       Max \n-0.027532 -0.004719  0.003220  0.007924  0.017478 \n\nCoefficients:\n             Estimate Std. Error t value Pr(>|t|)    \n(Intercept) -0.016550   0.002254  -7.342 4.35e-08 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\nResidual standard error: 0.01235 on 29 degrees of freedom\n```\n:::\n:::\n\n\nAs we can see from this summary output of the level 2 model, there is a significant decrease in powerplay goals per games played over time on average across teams. \n\nThis information was gleaned in the following ways:\n\n1) The estimate is -0.0166\n\nBy being negative, the estimate tells us that powerplay goals are decreasing over time. Specifically, they are decreasing at a rate of 0.0166 goals per games played per year\n\n2) This is statistically different from 0\n\nThe t-value is -7.34 with a p-value < .001\n\nOne way to visualize these results is to plot each team's predicted model from level 1. Running a linear model on these predicted estimates is equivalent to their average over time. The following code illustrates this process in ggplot2. One plot calculates the linear regression model of these estimates, while the other simply averages them over each timepoint:\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nlevel2Fits <- augment(level2) # Extracts model fits\n\n# LM plot\nlmPlot <- \n  ggplot(level1Fits, aes(StartYear, .fitted, group = Team)) +\n  geom_line(alpha = 1/3) +\n  geom_smooth(aes(group = 1), method = 'lm', color = 'purple', se = F) +\n  labs(\n    x = 'Season Start Year',\n    y = 'Level 1 Estimates (Power Play Goals/Games Played)',\n    title = 'Linear Model Plot'\n    ) +\n  theme_minimal()\n\n# Average plot\navPlot <- \n  ggplot(level1Fits, aes(StartYear, .fitted, group = Team)) +\n  geom_line(alpha = 1/3) +\n  stat_summary(\n    aes(group = 1), \n    fun = 'mean', \n    geom = 'line', \n    color = 'red', \n    size = 1\n    ) +\n  labs(x = 'Season Start Year', y = NULL, title = 'Average Plot') +\n  theme_minimal()\n\n# Plots them together\ngrid.arrange(lmPlot, avPlot, ncol = 2)\n```\n\n::: {.cell-output-display}\n![](post-Multilevel-Modeling-in-R-with-NHL-Power-Play-Data_files/figure-html/level2_plot-1.png){fig-align='center' width=672}\n:::\n:::\n\n\nAs we can see above, both these processes produce the same result. Powerplay goals are decreasing, on average, given each team's performace across one decade of play (2007-2017).\n\n## Level 2 Extended\n\nSo far we've modeled each team individually using linear regression and then compared the regression coefficients from each of these 30 models. However, we've ignored the hierarchical structure of these data. Teams are nested within divisions that are nested within conferences that are nested within leagues (in this case, only one = the NHL). \n\nIn this section, we'll explore the differences between conferences and divisions by adding these predictors to the level 2 analysis. **Again, each team's division and conference affiliation was determined using the 2013-2014 NHL realignment. This has serious consequences for interpreting the results and is shown for illustrative purposes.**\n\nThe divisions and conferences are considered categorical variables. When using categorical variables, it is best to have *a priori* (planned) comparisons. Thus, we have the following planned predictions:\n\n1. The Western conference will have higher powerplay goals/games played than the Eastern conference\n2. Within the West, the Central division will have higher powerplay goals/games played than the Pacific\n3. Within the East, the Metropolitan division will have higher powerplay goals/games played than the Atlantic\n\nIn order to incorporate these planned comparisons, we have come up with the following coding scheme:\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n# Creates the data frame for html table\ncontrasts <- \n  data.frame(\n    Contrast = c(\n      'Conference (West vs. East)', \n      'West (Pacific vs. Central)', \n      'East (Metropolitan vs. Atlantic)'\n      ),\n    Pacific = c(.5, -.5, 0),\n    Central = c(.5, .5, 0),\n    Metropolitan = c(-.5, 0, .5),\n    Atlantic = c(-.5, 0, -.5)\n    )\n\n# Prints table\nkable(contrasts) %>%\n  kable_styling(bootstrap_options = c('striped', 'hover', 'responsive'))\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table table-striped table-hover table-responsive\" style=\"margin-left: auto; margin-right: auto;\">\n <thead>\n  <tr>\n   <th style=\"text-align:left;\"> Contrast </th>\n   <th style=\"text-align:right;\"> Pacific </th>\n   <th style=\"text-align:right;\"> Central </th>\n   <th style=\"text-align:right;\"> Metropolitan </th>\n   <th style=\"text-align:right;\"> Atlantic </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> Conference (West vs. East) </td>\n   <td style=\"text-align:right;\"> 0.5 </td>\n   <td style=\"text-align:right;\"> 0.5 </td>\n   <td style=\"text-align:right;\"> -0.5 </td>\n   <td style=\"text-align:right;\"> -0.5 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> West (Pacific vs. Central) </td>\n   <td style=\"text-align:right;\"> -0.5 </td>\n   <td style=\"text-align:right;\"> 0.5 </td>\n   <td style=\"text-align:right;\"> 0.0 </td>\n   <td style=\"text-align:right;\"> 0.0 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> East (Metropolitan vs. Atlantic) </td>\n   <td style=\"text-align:right;\"> 0.0 </td>\n   <td style=\"text-align:right;\"> 0.0 </td>\n   <td style=\"text-align:right;\"> 0.5 </td>\n   <td style=\"text-align:right;\"> -0.5 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\nThese contrasts were made so that the estimates would be more interpretable. For example, the regression coefficient estimate for the West contrast will now represent the actual mean difference of Pacific vs. Central for powerplay goals/games played.\n\nUsing the level1Coef dataframe, let's enter 3 contrast columns, one for each planned comparison, based upon the table above:\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n# Division assignment\npacific <- c('S.J', 'CGY', 'L.A', 'ANA', 'EDM', 'VAN', 'ARI')\ncentral <- c('ATL.WPG', 'NSH', 'STL', 'DAL', 'COL', 'MIN', 'CHI')\nmetropolitan <- c('WSH', 'N.J', 'PHI', 'CBJ', 'PIT', 'NYR', 'NYI', 'CAR')\natlantic <- c('T.B', 'BOS', 'TOR', 'DET', 'MTL', 'FLA', 'OTT', 'BUF')\n\n# Assigning contrasts based on vectors above\nlevel1Coef <- level1Coef %>% ungroup() %>%\n  mutate(conf = case_when(level1Coef$Team %in% pacific ~ .5,\n                              level1Coef$Team %in% central ~ .5,\n                              level1Coef$Team %in% metropolitan ~ -.5,\n                              level1Coef$Team %in% atlantic ~ -.5),\n         west = case_when(level1Coef$Team %in% pacific ~ -.5,\n                              level1Coef$Team %in% central ~ .5,\n                              level1Coef$Team %in% metropolitan ~ 0,\n                              level1Coef$Team %in% atlantic ~ 0),\n         east = case_when(level1Coef$Team %in% pacific ~ 0,\n                              level1Coef$Team %in% central ~ 0,\n                              level1Coef$Team %in% metropolitan ~ .5,\n                              level1Coef$Team %in% atlantic ~ -.5))\n```\n:::\n\n\nWe can now run a linear regression on the regression coefficients from level 1 again, but this time we'll add the contrast coding scheme that we just created to the model in level 2:\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nlevel2Div <- lm(estimate ~ conf + west + east, data = level1Coef)\nsummary(level2Div)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\nCall:\nlm(formula = estimate ~ conf + west + east, data = level1Coef)\n\nResiduals:\n      Min        1Q    Median        3Q       Max \n-0.024390 -0.008290  0.002767  0.010203  0.014928 \n\nCoefficients:\n             Estimate Std. Error t value Pr(>|t|)    \n(Intercept) -0.016514   0.002293  -7.203 1.19e-07 ***\nconf         0.001077   0.004586   0.235    0.816    \nwest         0.007432   0.006698   1.110    0.277    \neast         0.005835   0.006265   0.931    0.360    \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\nResidual standard error: 0.01253 on 26 degrees of freedom\nMultiple R-squared:  0.07651,\tAdjusted R-squared:  -0.03005 \nF-statistic: 0.718 on 3 and 26 DF,  p-value: 0.5502\n```\n:::\n:::\n\n\nNow let's walk through this new summary output. \n\nFirst, our intercept estimate from level 2 and level 2 extended are very similar. Powerplay goals/games played are still significantly decreasing at a rate of .0166 per each year of NHL gameplay.\n\nSecond, our three planned contrasts were named 'conf', 'west', and 'east'. Taking a look at their estimates, they were all positive. This means that our predictions were in the right direction. However, none of these predictions were statistically significant. In other words, there is no significant difference in powerplay goals/games played between Western and Eastern conference teams, the Pacific and Central divisions, nor the Metropolitan and Atlantic divisions.\n\nNevertheless, let's take a look at each of these in turn. First, we'll extract the fitted values from the level 2 extended model for each team:\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n# Extracts estimates from each team from level 2 extended\nlevel2DivTeam <- \n  level2Div %>% \n  broom::augment(se_fit = TRUE) %>% \n  mutate(team = level1Coef$Team) %>% \n  ungroup() %>%\n  mutate(\n    division = case_when(\n      team %in% pacific ~ 'pacific',\n      team %in% central ~ 'central',\n      team %in% metropolitan ~ 'metropolitan',\n      team %in% atlantic ~ 'atlantic'\n      ),\n    division = factor(division)\n    )\n\n# Re-orders factor for plotting\nlevel2DivTeam$division <- \n  factor(level2DivTeam$division, levels(level2DivTeam$division)[c(4,2,3,1)])\n```\n:::\n\n\nAfter extracting this information, let's take a look within the Western conference and compare the Pacific and Central divisions:\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n# Gathers summary info\nwest_sum <- \n  level2DivTeam %>%\n  group_by(west) %>%\n  summarise(\n    mean = mean(.fitted),\n    sd = sd(.fitted),\n    n = n(),\n    sem = sd/sqrt(n)\n    ) %>%\n  filter(west != 0)\n\n# Plot\nggplot(west_sum, aes(factor(west), mean, group = 1)) +\n  geom_point(size = 2) +\n  geom_line(alpha = 1/3) +\n  scale_x_discrete(\n    'Western Conference Divisions', \n    label = c('Pacific', 'Central')\n    ) +\n  labs(y = 'Yearly Change in Power Play Goals/Games Played') +\n  theme_minimal()\n```\n\n::: {.cell-output-display}\n![](post-Multilevel-Modeling-in-R-with-NHL-Power-Play-Data_files/figure-html/level2eWest-1.png){fig-align='center' width=672}\n:::\n:::\n\n\nThe plot above depicts that, on average, the Pacific division is decreasing its powerplay goals/games played at a faster rate than the Central division. Although this is not a significant difference, it is still interesting.\n\nNext, let's take a look at within the Eastern conference between the Atlantic and Metropolitan divisions:\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n# Gathers summary info\neast_sum <- \n  level2DivTeam %>%\n  group_by(east) %>%\n  summarise(\n    mean = mean(.fitted),\n    sd = sd(.fitted),\n    n = n(),\n    sem = sd/sqrt(n)\n    ) %>%\n  filter(east != 0)\n\n# Plot\nggplot(east_sum, aes(factor(east), mean, group = 1)) +\n  geom_point(size = 2) +\n  geom_line(alpha = 1/3) +\n  scale_x_discrete(\n    'Eastern Conference Divisions', \n    label = c('Atlantic', 'Metropolitan')\n    ) +\n  labs(y = 'Yearly Change in Power Play Goals/Games Played') +\n  theme_minimal()\n```\n\n::: {.cell-output-display}\n![](post-Multilevel-Modeling-in-R-with-NHL-Power-Play-Data_files/figure-html/level2eEast-1.png){fig-align='center' width=672}\n:::\n:::\n\n\nSimilar to the Western conference, the teams in the Atlantic division, on average, have a greater decrease in their powerplay goals/games played compared to their conference counterparts--the Metropolitan division teams. This is not a significant difference, though.\n\nFinally, let's compare the Western and Eastern conferences:\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n# Gathering summary information\nconf_sum <- \n  level2DivTeam %>%\n  group_by(conf) %>%\n  summarise(\n    mean = mean(.fitted),\n    sd = sd(.fitted),\n    n = n(),\n    sem = sd/sqrt(n)\n    )\n\n# Plot\nggplot(conf_sum, aes(factor(conf), mean, group = 1)) +\n  geom_point(size = 2) +\n  geom_line(alpha = 1/3) +\n  scale_x_discrete(\n    'NHL Conference', \n    label = c('East', 'West')\n    ) +\n  labs(y = 'Yearly Change in Power Play Goals/Games Played') +\n  theme_minimal()\n```\n\n::: {.cell-output-display}\n![](post-Multilevel-Modeling-in-R-with-NHL-Power-Play-Data_files/figure-html/level2eConf-1.png){fig-align='center' width=672}\n:::\n:::\n\n\nInterestingly, the Eastern conference is decreasing in their powerplay goals/games played at a faster rate than the Western conference teams. Again, not a significant difference though.\n\nIt may be more helpful to examine these slopes side-by-side:\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n# Taking a look at the west contrast (Pacific -.5 vs. Central +.5)\nyax.lock <- c(-.025, -.01)\nwestPlot <- ggplot(west_sum, aes(factor(west), mean, group = 1)) +\n  geom_point(size = 2) +\n  geom_line(alpha = 1/3) +\n  scale_x_discrete(\n    'Western Conference Divisions', \n    label = c('Pacific', 'Central')\n    ) +\n  coord_cartesian(ylim = yax.lock) +\n  labs(y = 'Yearly Change in Power Play Goals/Games Played') +\n  theme_minimal()\n\n# Taking a look at the east contrast (Atlantic -.5 vs. Metropolitan +.5)\neastPlot <- ggplot(east_sum, aes(factor(east), mean, group = 1)) +\n  geom_point(size = 2) +\n  geom_line(alpha = 1/3) +\n  scale_x_discrete(\n    'Eastern Conference Divisions',\n    label = c('Atlantic', 'Metropolitan')\n    ) +\n  coord_cartesian(ylim = yax.lock) +\n  labs(y = NULL) +\n  theme_minimal()\n\n# Taking a look at the conference (East -.5 vs. West +.5)\nconfPlot <- ggplot(conf_sum, aes(factor(conf), mean, group = 1)) +\n  geom_point(size = 2) +\n  geom_line(alpha = 1/3) +\n  scale_x_discrete('NHL Conference', label = c('East', 'West')) +\n  coord_cartesian(ylim = yax.lock) +\n  labs(y = NULL) +\n  theme_minimal()\n\ngrid.arrange(westPlot, eastPlot, confPlot, ncol = 3)\n```\n\n::: {.cell-output-display}\n![](post-Multilevel-Modeling-in-R-with-NHL-Power-Play-Data_files/figure-html/level2eSum-1.png){fig-align='center' width=672}\n:::\n:::\n\n\nOr perhaps on a single plot detailing all 4 divisions across the 2 conferences:\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nggplot(level2DivTeam, aes(division, .fitted, group = factor(conf))) +\n  geom_pointrange(aes(ymax = .fitted + .se.fit, ymin = .fitted - .se.fit)) +\n  geom_line(alpha = 1/3) +\n  coord_cartesian(ylim = yax.lock) +\n  scale_x_discrete(\n    labels = c('Pacific', 'Central', 'Metropolitan', 'Atlantic')\n    ) +\n  labs(\n    x = 'Division', \n    y = 'Yearly Change in Power Play Goals/Games Played',\n    caption = 'SEM error bars'\n    ) +\n  theme_minimal()\n```\n\n::: {.cell-output-display}\n![](post-Multilevel-Modeling-in-R-with-NHL-Power-Play-Data_files/figure-html/unnamed-chunk-4-1.png){fig-align='center' width=672}\n:::\n:::\n\n\n# Conclusion\n\nHere are the following things we learned about 5 on 4 powerplays in the NHL from 2007-2017 in the regular season:\n\n1. The number of goals scored (controlled for the amount of games played per season) significantly decreased across the decade by a rate of .0166\n\n2. These decreases did not depend on division nor conference\n\n\n# Acknowledgements\n\nA huge thank you to Ekarin Pongpipat who graciously and generously taught me multi-level linear modeling & helped write this blog post. His patience for my random tangents about hockey, bitcoin, and data visualization was unparalleled! Thank you!\n\nEkarin is a first year PhD student at the University of Texas at Dallas in the Cognition and Neuroscience program. He obtained his statistics training using a model comparison approach (MCA) during his time at San Diego State University. He also has taught and continues to teach statistics conceptually, mathmatically, and using statistics software such as SPSS and R. He has recently written a function to write a statistical results template in a APA format and will be adding more to his [github](https://github.com/epongpipat) repository soon. If you're also interested in his research, check out his [ResearchGate](https://www.researchgate.net/profile/Ekarin_Pongpipat) page.\n\n<!-- disqus START -->\n\n<div id=\"disqus_thread\"></div>\n<script>\n/**\n*  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.\n*  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/\n/*\nvar disqus_config = function () {\nthis.page.url = 'https://mattkmiecik.com/post-Multilevel-Modeling-in-R-with-NHL-Power-Play-Data.html';  // Replace PAGE_URL with your page's canonical URL variable\nthis.page.identifier = 'post-Multilevel-Modeling-in-R-with-NHL-Power-Play-Data'; // Replace PAGE_IDENTIFIER with your page's unique identifier variable\n};\n*/\n(function() { // DON'T EDIT BELOW THIS LINE\nvar d = document, s = d.createElement('script');\ns.src = 'https://mattkmiecik.disqus.com/embed.js';\ns.setAttribute('data-timestamp', +new Date());\n(d.head || d.body).appendChild(s);\n})();\n</script>\n<noscript>Please enable JavaScript to view the <a href=\"https://disqus.com/?ref_noscript\">comments powered by Disqus.</a></noscript>\n\n<!-- disqus END -->\n",
    "supporting": [
      "post-Multilevel-Modeling-in-R-with-NHL-Power-Play-Data_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<script src=\"../site_libs/kePrint-0.0.1/kePrint.js\"></script>\n<link href=\"../site_libs/lightable-0.0.1/lightable.css\" rel=\"stylesheet\" />\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}