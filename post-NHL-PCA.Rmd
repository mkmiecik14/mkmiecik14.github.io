---
title: "NHL PCA"
author: "Matthew J. Kmiecik & Ekarin E. Pongpipat"
date: "date here"
output:
  html_document:
    highlight: zenburn
    toc: yes
    toc_depth: 3
    toc_float:
      collapsed: yes
      smooth_scroll: yes
---

```{r setup, include=F}
knitr::opts_chunk$set(echo = TRUE, fig.align = 'center')
options(knitr.table.format = 'html') # For the html tables
```

## Setup
<hr >

Here are the packages that we'll use for these analyses and to style the output/plots.

```{r}
# Packages ----
library(tidyverse)    # For data manipulation, plotting, etc. 
library(RCurl)        # To import data on github
library(TInPosition)  # PCA tools
library(ggrepel)      # Plotting tool for ggplot2
library(kableExtra)   # HTML table tools

# Custom functions ----
# nice_table() simplifies the printing of HTML tables using kable
nice_table <- function(x){
  
  kable(x) %>%
    kable_styling(bootstrap_options = c('striped', 'hover', 'responsive'))
  
}
```

Let's first prepare the data for analysis. These data were downloaded from [Corsica's](http://corsica.hockey/) team stats tool. We've prepared these data for you and are available for import into R like this:

```{r import}
# do the R curl thing here
```


To make things as simple as possible, without losing information, we'll use Chicago Blackhawk's data from the 2007-2008 season up through the 2017-2018 season (11 years of data) and only a subset of the available metrics. These include:

+ Games Played (GP)
+ Time on Ice (TOI)
+ Corsi For (CF) = [insert equation here]
+ Corsi Against (CA) = [insert equation here]
+ Goals For (GF)
+ Goals Against (GA)
+ Pentaly minutes served (PENT)
+ Penalty minutes drawn (PEND)
+ Shooting Percentage (ShootPerc) = [insert equation here]
+ Save Percentage (SavePerc) = [insert equation here]

```{r}
# Preparing Hawks data ----
hawks_data <- read_csv("data/nhl-team-data-corsica.csv") %>%
  select(Team:CA, GF, GA, PENT, PEND, ShootPerc = `Sh%`, SavePerc = `Sv%`) %>%
  filter(Team == "CHI") %>%
  separate(Season, into = c("Start_Year", "Season")) %>%
  mutate(Team = NULL, 
         Start_Year = NULL,
         Season = as.numeric(Season)
         )

nhl_data_mat <- as.matrix(nhl_data[,2:ncol(nhl_data)])
rownames(nhl_data_mat) <- nhl_data$Season

nhl_data_mat_scaled <- apply(nhl_data_mat, 2, scale)

nhl_data_svd <- svd(nhl_data_mat_scaled)

rows <- nhl_data_svd$u %*% diag(nhl_data_svd$d)
columns <- nhl_data_svd$v %*% diag(nhl_data_svd$d)


fis <- as.tibble(rows) %>% 
  mutate(Season = nhl_data$Season,
         SCW = factor(ifelse(Season %in% c("2009_2010", "2012_2013", "2014_2015"), "Won", "Lost"))
         )

fjs <- as.tibble(columns) %>% 
  mutate(meas = colnames(nhl_data)[-1])

inertia <- sum(nhl_data_svd$d)

scree <- tibble(eigs = nhl_data_svd$d, 
                perc_explained = (eigs/inertia)*100,
                comps = 1:length(eigs)
                )

ggplot(scree, aes(factor(comps), eigs)) +
  geom_point() +
  geom_path(aes(group = 1)) +
  scale_y_continuous(sec.axis = sec_axis(~./inertia * 100, 
                                         name = "Percentage of Explained Variance"
                                         )
                     ) +
  theme_minimal()


ggplot(fis, aes(V2, V3, color = SCW)) +
  geom_vline(xintercept = 0, alpha = 2/3) +
  geom_hline(yintercept = 0, alpha = 2/3) +
  geom_point() +
  coord_cartesian(xlim = c(-7,7), ylim = c(-7,7)) +
  scale_color_brewer(palette = "Dark2") +
  geom_text_repel(aes(label = Season), segment.alpha = 0) +
  theme_classic() +
  theme(axis.title=element_blank(),
        #axis.text=element_blank(),
        axis.ticks=element_blank(),
        axis.line = element_blank()
        )

ggplot(fjs, aes(V2, V3)) +
  geom_vline(xintercept = 0, alpha = 2/3) +
  geom_hline(yintercept = 0, alpha = 2/3) +
  geom_point() +
  coord_cartesian(xlim = c(-7,7), ylim = c(-7,7)) +
  scale_color_brewer(palette = "Dark2") +
  geom_text_repel(aes(label = meas), segment.alpha = 0) +
  theme_classic() +
  theme(axis.title=element_blank(),
        #axis.text=element_blank(),
        axis.ticks=element_blank(),
        axis.line = element_blank()
        )

ggplot(nhl_data, aes(PEND, PENT)) +
  geom_point() +
  geom_smooth(method = "lm")

cor.test(nhl_data$PENT, nhl_data$PEND)
summary(lm(PENT~PEND, data = nhl_data))
```

```{r}
gp <- nhl_data$GP

nhl_data_mat_2 <- as.matrix(nhl_data[3:ncol(nhl_data)])

nhl_data_scaled1 <- apply(nhl_data_mat_2[,1:7], 2, function(x){x/gp})

nhl_ready <- cbind(nhl_data_scaled1, nhl_data_mat_2[,8:9])

nhl_scaled <- apply(nhl_ready, 2, scale)

nhl_svd <- svd(nhl_scaled)

rows <- nhl_svd$u %*% diag(nhl_svd$d)
columns <- nhl_svd$v %*% diag(nhl_svd$d)

fis <- as.tibble(rows) %>% 
  mutate(Season = nhl_data$Season,
         SCW = factor(ifelse(Season %in% c("2009_2010", "2012_2013", "2014_2015"), "Won", "Lost"))
         )

fjs <- as.tibble(columns) %>% 
  mutate(meas = colnames(nhl_data)[3:ncol(nhl_data)])

inertia <- sum(nhl_svd$d)

scree <- tibble(eigs = nhl_svd$d, 
                perc_explained = (eigs/inertia)*100,
                comps = 1:length(eigs)
                )

ggplot(scree, aes(factor(comps), eigs)) +
  geom_point() +
  geom_path(aes(group = 1)) +
  scale_y_continuous(sec.axis = sec_axis(~./inertia * 100, 
                                         name = "Percentage of Explained Variance"
                                         )
                     ) +
  theme_minimal()

ggplot(fis, aes(V1, V2, color = SCW)) +
  geom_vline(xintercept = 0, alpha = 2/3) +
  geom_hline(yintercept = 0, alpha = 2/3) +
  geom_point() +
  coord_cartesian(xlim = c(-7,7), ylim = c(-7,7)) +
  scale_color_brewer(palette = "Dark2") +
  geom_text_repel(aes(label = Season), segment.alpha = 0) +
  theme_classic() +
  theme(axis.title=element_blank(),
        #axis.text=element_blank(),
        axis.ticks=element_blank(),
        axis.line = element_blank()
        )

ggplot(fjs, aes(V1, V2)) +
  geom_vline(xintercept = 0, alpha = 2/3) +
  geom_hline(yintercept = 0, alpha = 2/3) +
  geom_point() +
  coord_cartesian(xlim = c(-7,7), ylim = c(-7,7)) +
  scale_color_brewer(palette = "Dark2") +
  geom_text_repel(aes(label = meas), segment.alpha = 0) +
  theme_classic() +
  theme(axis.title=element_blank(),
        #axis.text=element_blank(),
        axis.ticks=element_blank(),
        axis.line = element_blank()
        )
```

